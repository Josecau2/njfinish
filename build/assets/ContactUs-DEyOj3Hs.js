import{j as e}from"./date-vendor-DfW9khhA.js";import{r as s}from"./react-vendor-Dhx0OYb2.js";import{a}from"./redux-vendor-B0DAdCYB.js";import{P as t}from"./PageHeader-UABCfWk-.js";import{a as n,u as o}from"./index-CRxBN8Fj.js";import{i as c}from"./DefaultLayout-CNvO87EM.js";import{b as i,d as l,a3 as d,v as r,R as m,S as h,a6 as x,a4 as u,V as j,a5 as p,e as b,X as w,Y as g,aj as y,ak as N,N as f,B as v,E as C,O as S,Q as A}from"./ui-vendor-pFEG3kEv.js";import"./form-vendor-C_vzjFiG.js";import"./utils-vendor-Nl-sF5xe.js";import"./icons-vendor-CVrEPnlB.js";const P=()=>n.get("/api/contact/info"),k=()=>n.get("/api/settings/customization/pdf"),H=({label:s,value:a,visible:t=!0})=>t&&a?e.jsxs("div",{className:"d-flex justify-content-between align-items-center py-2 border-bottom",children:[e.jsx("span",{className:"text-muted small",children:s}),e.jsx("span",{className:"fw-semibold",children:a})]}):null,E=({loading:s,info:a})=>{const{t:n}=o();return e.jsx(i,{className:"border-0 shadow-sm",children:e.jsxs(l,{children:[e.jsx(t,{title:n("contact.info.title"),subtitle:n("contact.info.subtitle"),mobileLayout:"compact",cardClassName:"mb-3"}),s?e.jsx("div",{className:"py-4 text-center text-muted",children:n("common.loading")}):e.jsxs(e.Fragment,{children:[e.jsx(H,{label:n("contact.info.companyName"),value:a?.companyName,visible:a?.showCompanyName}),e.jsx(H,{label:n("contact.info.email"),value:a?.email,visible:a?.showEmail}),e.jsx(H,{label:n("contact.info.phone"),value:a?.phone,visible:a?.showPhone}),e.jsx(H,{label:n("contact.info.address"),value:a?.address,visible:a?.showAddress}),e.jsx(H,{label:n("contact.info.website"),value:a?.website,visible:a?.showWebsite}),e.jsx(H,{label:n("contact.info.hours"),value:a?.hours,visible:a?.showHours}),a?.notes&&a?.showNotes&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-muted small mb-1",children:n("contact.info.notes")}),e.jsx("div",{className:"fw-semibold",children:a?.notes})]})]})]})})},W=({info:n,onSave:w})=>{const{t:g}=o(),y=a(e=>e.auth.user),N=s.useMemo(()=>c(y),[y]),[f,v]=s.useState({companyName:n?.companyName||"",email:n?.email||"",phone:n?.phone||"",address:n?.address||"",website:n?.website||"",hours:n?.hours||"",notes:n?.notes||"",showCompanyName:!1!==n?.showCompanyName,showEmail:!1!==n?.showEmail,showPhone:!1!==n?.showPhone,showAddress:!1!==n?.showAddress,showWebsite:!1!==n?.showWebsite,showHours:!1!==n?.showHours,showNotes:!1!==n?.showNotes}),[C,S]=s.useState(!1),A=e=>{const{name:s,value:a,type:t,checked:n}=e.target;v({...f,[s]:"checkbox"===t?n:a})};return N?e.jsx(i,{className:"border-0 shadow-sm",children:e.jsxs(l,{children:[e.jsx(t,{title:g("contact.editor.title"),subtitle:g("contact.editor.subtitle"),mobileLayout:"compact"}),e.jsxs(d,{onSubmit:async e=>{if(e.preventDefault(),N){S(!0);try{await w(f)}finally{S(!1)}}},className:"mt-2",children:[e.jsxs("div",{className:"mb-4 p-3 bg-light rounded",children:[e.jsxs("h6",{className:"mb-3 d-flex align-items-center",children:[e.jsx(r,{color:"info",className:"me-2",children:"Settings"}),g("contact.editor.visibilitySettings")]}),e.jsxs(m,{className:"g-2",children:[e.jsx(h,{md:6,children:e.jsx(x,{id:"showCompanyName",name:"showCompanyName",checked:f.showCompanyName,onChange:A,label:g("contact.info.companyName")})}),e.jsx(h,{md:6,children:e.jsx(x,{id:"showEmail",name:"showEmail",checked:f.showEmail,onChange:A,label:g("contact.info.email")})}),e.jsx(h,{md:6,children:e.jsx(x,{id:"showPhone",name:"showPhone",checked:f.showPhone,onChange:A,label:g("contact.info.phone")})}),e.jsx(h,{md:6,children:e.jsx(x,{id:"showWebsite",name:"showWebsite",checked:f.showWebsite,onChange:A,label:g("contact.info.website")})}),e.jsx(h,{md:6,children:e.jsx(x,{id:"showAddress",name:"showAddress",checked:f.showAddress,onChange:A,label:g("contact.info.address")})}),e.jsx(h,{md:6,children:e.jsx(x,{id:"showHours",name:"showHours",checked:f.showHours,onChange:A,label:g("contact.info.hours")})}),e.jsx(h,{md:6,children:e.jsx(x,{id:"showNotes",name:"showNotes",checked:f.showNotes,onChange:A,label:g("contact.info.notes")})})]})]}),e.jsxs("h6",{className:"mb-3 d-flex align-items-center",children:[e.jsx(r,{color:"primary",className:"me-2",children:"Content"}),g("contact.editor.contentSettings")]}),e.jsxs("div",{className:"mb-2",children:[e.jsxs(u,{children:[g("contact.info.companyName")," ",!f.showCompanyName&&e.jsx(r,{color:"secondary",className:"ms-2",children:"Hidden"})]}),e.jsx(j,{name:"companyName",value:f.companyName,onChange:A,disabled:!f.showCompanyName})]}),e.jsxs("div",{className:"mb-2",children:[e.jsxs(u,{children:[g("contact.info.email")," ",!f.showEmail&&e.jsx(r,{color:"secondary",className:"ms-2",children:"Hidden"})]}),e.jsx(j,{type:"email",name:"email",value:f.email,onChange:A,disabled:!f.showEmail})]}),e.jsxs("div",{className:"mb-2",children:[e.jsxs(u,{children:[g("contact.info.phone")," ",!f.showPhone&&e.jsx(r,{color:"secondary",className:"ms-2",children:"Hidden"})]}),e.jsx(j,{name:"phone",value:f.phone,onChange:A,disabled:!f.showPhone})]}),e.jsxs("div",{className:"mb-2",children:[e.jsxs(u,{children:[g("contact.info.address")," ",!f.showAddress&&e.jsx(r,{color:"secondary",className:"ms-2",children:"Hidden"})]}),e.jsx(p,{rows:3,name:"address",value:f.address,onChange:A,disabled:!f.showAddress})]}),e.jsxs("div",{className:"mb-2",children:[e.jsxs(u,{children:[g("contact.info.website")," ",!f.showWebsite&&e.jsx(r,{color:"secondary",className:"ms-2",children:"Hidden"})]}),e.jsx(j,{name:"website",value:f.website,onChange:A,disabled:!f.showWebsite})]}),e.jsxs("div",{className:"mb-2",children:[e.jsxs(u,{children:[g("contact.info.hours")," ",!f.showHours&&e.jsx(r,{color:"secondary",className:"ms-2",children:"Hidden"})]}),e.jsx(j,{name:"hours",value:f.hours,onChange:A,disabled:!f.showHours})]}),e.jsxs("div",{className:"mb-2",children:[e.jsxs(u,{children:[g("contact.info.notes")," ",!f.showNotes&&e.jsx(r,{color:"secondary",className:"ms-2",children:"Hidden"})]}),e.jsx(p,{rows:3,name:"notes",value:f.notes,onChange:A,disabled:!f.showNotes})]}),e.jsx(b,{type:"submit",color:"primary",className:"mt-2",children:g(C?"common.saving":"contact.editor.save")})]})]})}):null},_=({onSend:a})=>{const{t:n}=o(),[c,r]=s.useState(""),[m,h]=s.useState(""),[x,w]=s.useState(!1);return e.jsx(i,{className:"border-0 shadow-sm",children:e.jsxs(l,{children:[e.jsx(t,{title:n("contact.compose.title"),subtitle:n("contact.compose.subtitle"),mobileLayout:"compact"}),e.jsxs(d,{onSubmit:async e=>{if(e.preventDefault(),c.trim()&&m.trim()){w(!0);try{await a({subject:c.trim(),message:m.trim()}),r(""),h("")}finally{w(!1)}}},className:"mt-2",children:[e.jsxs("div",{className:"mb-2",children:[e.jsx(u,{children:n("contact.compose.subject")}),e.jsx(j,{value:c,onChange:e=>r(e.target.value),placeholder:n("contact.compose.subjectPh")})]}),e.jsxs("div",{className:"mb-2",children:[e.jsx(u,{children:n("contact.compose.message")}),e.jsx(p,{rows:5,value:m,onChange:e=>h(e.target.value),placeholder:n("contact.compose.messagePh")})]}),e.jsx(b,{type:"submit",color:"primary",children:n(x?"contact.compose.sending":"contact.compose.send")})]})]})})},L=({loading:a,threads:n,page:c,totalPages:d,onPageChange:m,onSelect:h,isAdmin:x,groupByUser:u=!1,onSelectUser:j})=>{const{t:p}=o(),b=s.useMemo(()=>{if(!u||!x||!Array.isArray(n))return[];const e=new Map;for(const s of n){const a=s.owner?.id||0,t=s.owner?.name||p("contact.history.unknownUser"),n=Number(s.unreadCount)||0,o=new Date(s.last_message_at||s.updatedAt||0).getTime(),c=e.get(a)||{userId:a,name:t,unread:0,lastAt:0,lastSubject:""};c.unread+=n,o>c.lastAt&&(c.lastAt=o,c.lastSubject=s.subject),e.set(a,c)}return Array.from(e.values()).sort((e,s)=>s.lastAt-e.lastAt)},[u,x,n,p]);return s.useEffect(()=>{},[]),e.jsx(i,{className:"border-0 shadow-sm",children:e.jsxs(l,{children:[e.jsx(t,{title:p("contact.history.title"),subtitle:p("contact.history.subtitle"),mobileLayout:"compact"}),a?e.jsx("div",{className:"py-3 text-center text-muted",children:p("common.loading")}):e.jsxs(e.Fragment,{children:[(!u||b&&0!==b.length)&&(u||n&&0!==n.length)?e.jsx(w,{children:u?b.map(s=>e.jsxs(g,{className:"d-flex justify-content-between align-items-center",role:"button",onClick:()=>j&&j(s.userId),children:[e.jsxs("div",{children:[e.jsx("div",{className:"fw-semibold",children:s.name}),s.lastAt>0&&e.jsxs("div",{className:"small text-muted",children:[new Date(s.lastAt).toLocaleString()," • ",s.lastSubject]})]}),e.jsx("div",{className:"d-flex align-items-center gap-2",children:Number(s.unread)>0&&e.jsx(r,{color:"danger",children:s.unread})})]},s.userId)):n.map(s=>e.jsxs(g,{className:"d-flex justify-content-between align-items-center",role:"button",onClick:()=>h(s.id),children:[e.jsx("div",{className:"d-flex flex-column",children:e.jsxs("div",{className:"d-flex align-items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"fw-semibold",children:s.subject}),x&&e.jsx(r,{color:"secondary",children:s.owner?.name||p("contact.history.unknownUser")}),e.jsx("span",{className:"small text-muted",children:new Date(s.last_message_at||s.updatedAt).toLocaleString()}),Number(s.unreadCount)>0&&e.jsx(r,{color:"danger",children:p("common.new")||"New"})]})}),e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[Number(s.unreadCount)>0&&e.jsx(r,{color:"danger",children:s.unreadCount}),e.jsx(r,{color:"open"===s.status?"success":"secondary",children:p("contact.status."+s.status)})]})]},s.id))}):e.jsx("div",{className:"py-3 text-center text-muted",children:p("contact.history.empty")}),d>1&&e.jsx("div",{className:"d-flex justify-content-center mt-3",children:e.jsxs(y,{size:"sm",children:[e.jsx(N,{disabled:1===c,onClick:()=>m(c-1),children:"«"}),[...Array(d)].map((s,a)=>e.jsx(N,{active:a+1===c,onClick:()=>m(a+1),children:a+1},a+1)),e.jsx(N,{disabled:c===d,onClick:()=>m(c+1),children:"»"})]})})]})]})})},D=({mine:s,author:a,text:t,time:n})=>e.jsx("div",{className:`d-flex ${s?"justify-content-end":"justify-content-start"} mb-2`,children:e.jsxs("div",{className:"p-2 rounded",style:{maxWidth:"85%",background:s?"#e9f5ff":"#f8f9fa",border:"1px solid #e3e6f0"},children:[e.jsxs("div",{className:"small text-muted mb-1",children:[a," • ",new Date(n).toLocaleString()]}),e.jsx("div",{className:"fw-semibold",style:{whiteSpace:"pre-wrap"},children:t})]})}),I=({loading:a,thread:n,onReply:c,onClose:d,isAdmin:m})=>{const{t:h}=o(),[x,u]=s.useState("");if(!n)return e.jsx(i,{className:"border-0 shadow-sm",children:e.jsx(l,{children:e.jsx(t,{title:h("contact.thread.title"),subtitle:h("contact.thread.empty"),mobileLayout:"compact"})})});return e.jsx(i,{className:"border-0 shadow-sm",children:e.jsxs(l,{children:[e.jsx(t,{title:n.subject,subtitle:h("contact.thread.subtitle"),mobileLayout:"compact",rightContent:e.jsx("div",{className:"d-flex gap-2",children:"open"===n.status&&e.jsx(b,{size:"sm",color:"secondary",onClick:()=>d&&d(n.id),children:h("contact.thread.close")})}),leftContent:m&&n.owner?.name?e.jsx("div",{className:"d-flex align-items-center gap-2",children:e.jsx(r,{color:"secondary",children:n.owner.name})}):null}),a?e.jsx("div",{className:"py-4 text-center text-muted",children:h("common.loading")}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-3",style:{minHeight:140},children:[(n.messages||[]).map(s=>e.jsx(D,{mine:s.is_admin===!!m,author:s.author?.name||(s.is_admin?h("contact.thread.admin"):h("contact.thread.user")),text:s.body,time:s.createdAt},s.id)),0===n.messages?.length&&e.jsx("div",{className:"text-center text-muted py-4",children:h("contact.thread.noMessages")})]}),"open"===n.status&&e.jsxs("div",{className:"d-flex gap-2 align-items-start",children:[e.jsxs("div",{className:"flex-grow-1",children:[e.jsx(p,{rows:3,value:x,onChange:e=>u(e.target.value),placeholder:h("contact.compose.messagePh")}),Array.isArray(n.messages)&&n.messages.some(e=>!e.read_by_recipient&&(m?!e.is_admin:e.is_admin))&&e.jsx("div",{className:"mt-1",children:e.jsx(r,{color:"danger",children:h("common.new")||"New"})})]}),e.jsx(b,{color:"primary",onClick:async()=>{x.trim()&&(await c(n.id,x.trim()),u(""))},children:h("contact.thread.reply")})]})]})]})})},U=()=>{const{t:d}=o(),r=a(e=>e.auth.user),x=s.useMemo(()=>c(r),[r]),[u,j]=s.useState("contact"),[p,b]=s.useState(null),[w,g]=s.useState(!0),[y,N]=s.useState([]),[H,D]=s.useState({page:1,totalPages:1}),[U,M]=s.useState(!1),[$,F]=s.useState(null),[R,z]=s.useState(!1),[B,V]=s.useState(null);s.useEffect(()=>{let e=!0;return g(!0),Promise.all([P().catch(e=>({data:{data:null}})),k().catch(e=>({data:null}))]).then(([s,a])=>{if(!e)return;const t=s?.data?.data||{},n=a?.data||{},o={companyName:t.companyName||n.companyName||"",email:t.email||n.companyEmail||"",phone:t.phone||n.companyPhone||"",website:t.website||n.companyWebsite||"",address:t.address||n.companyAddress||"",hours:t.hours||"",notes:t.notes||"",showCompanyName:!1!==t.showCompanyName,showEmail:!1!==t.showEmail,showPhone:!1!==t.showPhone,showWebsite:!1!==t.showWebsite,showAddress:!1!==t.showAddress,showHours:!1!==t.showHours,showNotes:!1!==t.showNotes};b(o)}).catch(s=>{e&&b(null)}).finally(()=>e&&g(!1)),()=>{e=!1}},[]),s.useEffect(()=>{x&&"inbox"!==u&&"info"!==u&&j("inbox")},[x]);const O=(e=1,s=null)=>{M(!0);const a={page:e};x&&s&&(a.userId=s),(e=>n.get("/api/contact/threads",{params:e}))(a).then(e=>{N(e?.data?.data||[]),D(e?.data?.pagination||{page:1,totalPages:1})}).catch(e=>{N([]),D({page:1,totalPages:1})}).finally(()=>M(!1))};s.useEffect(()=>{O(1,B)},[x,B]);const Q=async e=>{z(!0),(e=>n.get(`/api/contact/threads/${e}`))(e).then(s=>{F(s?.data?.data),N(s=>Array.isArray(s)?s.map(s=>s.id===e?{...s,unreadCount:0}:s):s),x&&(e=>n.post(`/api/contact/threads/${e}/read`))(e).then(()=>{F(s=>{if(!s||s.id!==e)return s;return{...s,messages:(s.messages||[]).map(e=>(e=>!e.is_admin)(e)?{...e,read_by_recipient:!0,read_at:e.read_at||(new Date).toISOString()}:e)}})}).catch(()=>{})}).catch(e=>{F(null)}).finally(()=>z(!1))},T=async(e,s)=>{try{await((e,s)=>n.post(`/api/contact/threads/${e}/messages`,{body:s}))(e,s),Q(e)}catch(a){}};return e.jsxs(e.Fragment,{children:[e.jsx(t,{title:d("contact.header"),subtitle:d("contact.subtitle"),mobileLayout:"stack",badge:{text:d(x?"contact.adminView":"contact.userView"),variant:"secondary"}}),e.jsx(m,{children:e.jsx(h,{xs:12,children:x?e.jsx(i,{className:"border-0 shadow-sm",children:e.jsxs(l,{children:[e.jsxs(f,{variant:"tabs",role:"tablist",className:"mb-3 flex-nowrap overflow-auto",children:[e.jsx(v,{children:e.jsx(C,{active:"inbox"===u,onClick:()=>j("inbox"),children:d("contact.inbox")})}),e.jsx(v,{children:e.jsx(C,{active:"info"===u,onClick:()=>j("info"),children:d("contact.infoTab")})})]}),e.jsxs(S,{children:[e.jsx(A,{visible:"inbox"===u,children:e.jsxs(m,{className:"g-3",children:[e.jsx(h,{md:4,children:e.jsx(L,{loading:U,threads:y,page:H.page,totalPages:H.totalPages,onPageChange:e=>O(e,B),onSelect:Q,isAdmin:!0,groupByUser:!B,onSelectUser:e=>{V(e),F(null),O(1,e)}})}),e.jsx(h,{md:8,children:e.jsx(I,{loading:R,thread:$,onReply:T,onClose:async e=>{try{await(e=>n.post(`/api/contact/threads/${e}/close`))(e),O(H.page),F(s=>s&&s.id===e?{...s,status:"closed"}:s)}catch(s){}},isAdmin:!0})})]})}),e.jsx(A,{visible:"info"===u,children:e.jsxs(m,{className:"g-3",children:[e.jsx(h,{lg:6,children:e.jsx(E,{loading:w,info:p})}),e.jsx(h,{lg:6,children:e.jsx(W,{info:p,onSave:async e=>{try{await(e=>n.put("/api/contact/info",e))(e);const[s,a]=await Promise.all([P().catch(e=>({data:{data:null}})),k().catch(e=>({data:null}))]),t=s?.data?.data||{},o=a?.data||{},c={companyName:t.companyName||o.companyName||"",email:t.email||o.companyEmail||"",phone:t.phone||o.companyPhone||"",website:t.website||o.companyWebsite||"",address:t.address||o.companyAddress||"",hours:t.hours||"",notes:t.notes||"",showCompanyName:!1!==t.showCompanyName,showEmail:!1!==t.showEmail,showPhone:!1!==t.showPhone,showWebsite:!1!==t.showWebsite,showAddress:!1!==t.showAddress,showHours:!1!==t.showHours,showNotes:!1!==t.showNotes};b(c)}catch(s){}}})})]})})]})]})}):e.jsxs(m,{className:"g-3",children:[e.jsx(h,{lg:5,children:e.jsx(E,{loading:w,info:p})}),e.jsxs(h,{lg:7,children:[e.jsx(_,{onSend:async({subject:e,message:s})=>{try{const t=await(a={subject:e,message:s},n.post("/api/contact/threads",a));O(1),t?.data?.data?.threadId&&Q(t.data.data.threadId)}catch(t){}var a}}),e.jsx("div",{className:"mt-3",children:e.jsx(L,{loading:U,threads:y,page:H.page,totalPages:H.totalPages,onPageChange:e=>O(e),onSelect:Q,isAdmin:!1})}),e.jsx("div",{className:"mt-3",children:e.jsx(I,{loading:R,thread:$,onReply:T})})]})]})})})]})};export{U as default};
