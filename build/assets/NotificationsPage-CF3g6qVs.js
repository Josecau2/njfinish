import{j as e}from"./date-vendor-DfW9khhA.js";import{r as a}from"./react-vendor-Dhx0OYb2.js";import{h as s,R as t,S as r,b as i,c as l,e as n,r as o,d as c,ac as d,a6 as m,C as u,v as f,aj as p,ak as h}from"./ui-vendor-pFEG3kEv.js";import{u as x,a as j}from"./redux-vendor-B0DAdCYB.js";import{a as y,ab as g,ac as v,c as N,ad as b,a6 as w,ae as k,af as _}from"./index-CRxBN8Fj.js";import{E as C}from"./EmptyState-BfaRP2bj.js";import{c as S}from"./cil-reload-6LI_qKMh.js";import{c as A}from"./cil-check-alt-Bgti_PMs.js";import"./form-vendor-C_vzjFiG.js";import"./utils-vendor-Nl-sF5xe.js";import"./icons-vendor-CVrEPnlB.js";import"./cil-search-CDkY_4k-.js";const z=()=>{const z=x(),{notifications:E,loading:F,error:P}=j(e=>e.notification),R=j(e=>e.auth?.user),L=(()=>{const e=String(R?.role||"").toLowerCase();return"admin"===e||"super_admin"===e})(),[U,$]=a.useState(1),[B,M]=a.useState(1),[D,T]=a.useState("all"),[W,Y]=a.useState(""),[q,G]=a.useState(!1);a.useEffect(()=>{H()},[U,D,W]),a.useEffect(()=>{!L&&E&&E.some(e=>!e.is_read)&&(async()=>{try{await y.post("/api/notifications/mark-all-read"),z(g())}catch(e){}})()},[L,E?.length]);const H=async(e=!0)=>{e&&z(v(!0));try{const e={page:U,limit:20,..."unread"===D&&{unread_only:"true"},..."read"===D&&{read_only:"true"},...W&&{type:W}},{data:a}=await y.get("/api/notifications",{params:e});z(N(a.data)),M(a?.pagination?.totalPages||1),z(b(null))}catch(a){const e=a?.response?.status;z(b(401===e||403===e?"Not authorized to view notifications.":a.message))}finally{z(v(!1)),G(!1)}};a.useEffect(()=>{P&&w("Failed to load notifications","string"==typeof P?P:"")},[P]);const I=e=>{switch(e){case"proposal_accepted":return"✅";case"proposal_rejected":return"❌";case"customer_created":return"👤";case"system":return"⚙️";default:return"📧"}},J=e=>{switch(e){case"high":return"danger";case"medium":return"warning";case"low":return"info";default:return"secondary"}},K=E.filter(e=>"unread"===D?!e.is_read:"read"!==D||e.is_read),O=E.filter(e=>!e.is_read).length;return e.jsx(s,{fluid:!0,className:"py-4",children:e.jsx(t,{children:e.jsx(r,{children:e.jsxs(i,{children:[e.jsxs(l,{className:"d-flex justify-content-between align-items-center",children:[e.jsx("h4",{className:"mb-0",children:"Notifications"}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs(n,{variant:"outline",color:"primary",size:"sm",onClick:()=>{G(!0),H(!1)},disabled:q,children:[e.jsx(o,{icon:S,className:q?"fa-spin":""}),q?" Refreshing...":" Refresh"]}),O>0&&e.jsxs(n,{color:"success",size:"sm",onClick:async()=>{try{await y.post("/api/notifications/mark-all-read"),z(g()),H(!1),k("All caught up","All notifications marked as read")}catch(e){w("Failed to mark all as read",e.message)}},children:[e.jsx(o,{icon:A}),"Mark All Read (",O,")"]})]})]}),e.jsxs(c,{children:[e.jsxs("div",{className:"mb-3 d-flex flex-wrap gap-2 align-items-center",children:[e.jsxs(d,{children:[e.jsx(m,{type:"radio",button:{color:"outline-primary",variant:"outline"},name:"filter",id:"filter-all",label:"All",checked:"all"===D,onChange:()=>{T("all"),$(1)}}),e.jsx(m,{type:"radio",button:{color:"outline-primary",variant:"outline"},name:"filter",id:"filter-unread",label:`Unread (${O})`,checked:"unread"===D,onChange:()=>{T("unread"),$(1)}}),e.jsx(m,{type:"radio",button:{color:"outline-primary",variant:"outline"},name:"filter",id:"filter-read",label:"Read",checked:"read"===D,onChange:()=>{T("read"),$(1)}})]}),e.jsxs("div",{className:"ms-2 d-flex align-items-center",children:[e.jsx("label",{htmlFor:"type-filter",className:"me-2 mb-0 small text-muted",children:"Type"}),e.jsxs("select",{id:"type-filter",className:"form-select form-select-sm",style:{width:"220px"},value:W,onChange:e=>{Y(e.target.value),$(1)},children:[e.jsx("option",{value:"",children:"All types"}),e.jsx("option",{value:"proposal_accepted",children:"Proposal accepted"}),e.jsx("option",{value:"proposal_rejected",children:"Proposal rejected"}),e.jsx("option",{value:"customer_created",children:"Customer created"}),e.jsx("option",{value:"system",children:"System"})]})]})]}),P&&e.jsx("div",{className:"mb-3",children:e.jsx(C,{title:"Could not load notifications",subtitle:P})}),F&&e.jsx("div",{className:"text-center py-4",children:e.jsx(u,{})}),!F&&0===K.length&&e.jsx(C,{title:"unread"===D?"No unread notifications":"read"===D?"No read notifications":"No notifications",subtitle:W?`No notifications for type "${W}"`:"You are all caught up."}),!F&&K.map(a=>{return e.jsx(i,{className:"mb-3 notification-card "+(a.is_read?"":"notification-unread"),style:{borderLeft:a.is_read?"1px solid #dee2e6":"4px solid #007bff",backgroundColor:a.is_read?"white":"#f8f9fa",cursor:a.action_url?"pointer":"default"},onClick:()=>{a.action_url&&(window.location.href=a.action_url)},children:e.jsx(c,{className:"py-3",children:e.jsx("div",{className:"d-flex justify-content-between align-items-start",children:e.jsxs("div",{className:"d-flex align-items-start flex-grow-1",children:[e.jsx("div",{className:"me-3 mt-1",children:e.jsx("span",{style:{fontSize:"1.5rem"},children:I(a.type)})}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-start mb-1",children:[e.jsxs("h6",{className:"mb-1",children:[a.title,!a.is_read&&e.jsx(f,{color:"primary",className:"ms-2",children:"New"})]}),e.jsx(f,{color:J(a.priority),children:a.priority})]}),e.jsx("p",{className:"text-muted mb-2",children:a.message}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("small",{className:"text-muted",children:[(s=a.createdAt,new Date(s).toLocaleString()),a.createdByUser&&e.jsxs(e.Fragment,{children:[" • by ",a.createdByUser.name]})]}),e.jsx("div",{children:L&&!a.is_read&&e.jsx(n,{size:"sm",variant:"ghost",color:"primary",onClick:e=>{e.stopPropagation(),(async e=>{try{await y.post(`/api/notifications/${e}/read`),z(_(e))}catch(a){w("Failed to mark as read",a.message)}})(a.id)},children:"Mark as read"})})]})]})]})})})},a.id);var s}),B>1&&e.jsx("div",{className:"d-flex justify-content-center mt-4",children:e.jsxs(p,{children:[e.jsx(h,{disabled:1===U,onClick:()=>$(U-1),children:"Previous"}),Array.from({length:B},(e,a)=>a+1).map(a=>e.jsx(h,{active:a===U,onClick:()=>$(a),children:a},a)),e.jsx(h,{disabled:U===B,onClick:()=>$(U+1),children:"Next"})]})})]})]})})})})};export{z as default};
