import{j as e}from"./date-vendor-DfW9khhA.js";import{r as s,u as a}from"./react-vendor-Dhx0OYb2.js";import{u as r,q as o,r as t,g as c,m as l,t as n,a as i,v as p}from"./index-CRxBN8Fj.js";import{h as d}from"./DefaultLayout-CNvO87EM.js";import{u as m,a as u}from"./redux-vendor-B0DAdCYB.js";import{S as h}from"./utils-vendor-Nl-sF5xe.js";import{w as x}from"./withContractorScope-ddaNi-VC.js";import{i as j,j as f,k as g,l as b,a as w,a3 as y,a6 as N,R as v,S as C,a4 as A,V as S,m as k,e as D,C as P,h as T,r as F,v as B,b as M,d as L,T as E,U as $,Z as z,_ as q,$ as R,a0 as U,a1 as Z,a2 as I}from"./ui-vendor-pFEG3kEv.js";import{P as _}from"./PermissionGate-CqyDRWQG.js";import{P as G}from"./PaginationComponent-D6Bf1rUy.js";import{P as O}from"./PageHeader-UABCfWk-.js";import{a as H}from"./index-CN1WxwnF.js";import{c as V}from"./cil-plus-D8mtC-W5.js";import{c as Y}from"./cil-search-CDkY_4k-.js";import{c as J}from"./cil-pencil-m516yCOw.js";import{c as Q}from"./cil-trash-CBbKHhHb.js";import{c as W}from"./cil-paper-plane-haInf9fd.js";import{c as K}from"./cil-x-0440B5Ce.js";import"./form-vendor-C_vzjFiG.js";import"./icons-vendor-CVrEPnlB.js";var X=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M199.066,456l-7.379-7.514-3.94-3.9-86.2-86.2.053-.055L17.936,274.665l97.614-97.613,83.565,83.565L398.388,61.344,496,158.958,296.729,358.229,285.469,369.6ZM146.6,358.183l52.459,52.46.1-.1.054.054,52.311-52.311,11.259-11.368L450.746,158.958,398.388,106.6,199.115,305.871,115.55,222.306,63.191,274.665l83.464,83.463Z' class='ci-primary'/>"],ee=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M474.444,19.857a20.336,20.336,0,0,0-21.592-2.781L33.737,213.8v38.066l176.037,70.414L322.69,496h38.074l120.3-455.4A20.342,20.342,0,0,0,474.444,19.857ZM337.257,459.693,240.2,310.37,389.553,146.788l-23.631-21.576L215.4,290.069,70.257,232.012,443.7,56.72Z' class='ci-primary'/>"];const se=({show:a,onClose:t,proposal:c,onAcceptanceComplete:l,isContractor:n=!1})=>{const i=m(),{t:p}=r(),[d,u]=s.useState(!1),[x,T]=s.useState(""),[F,B]=s.useState(""),[M,L]=s.useState(!1),[E,$]=s.useState(""),z=()=>{M||(u(!1),T(""),B(""),$(""),t())};return e.jsxs(j,{visible:a,onClose:z,size:"lg",children:[e.jsx(f,{children:e.jsx(g,{children:p("proposalAcceptance.title")})}),e.jsxs(b,{children:[E&&e.jsx(w,{color:"danger",className:"mb-3",children:E}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h6",{children:p("proposalAcceptance.details")}),e.jsxs("p",{className:"mb-1",children:[e.jsxs("strong",{children:[p("proposalAcceptance.labels.customer"),":"]})," ",c?.customer?.name||p("common.na")]}),e.jsxs("p",{className:"mb-1",children:[e.jsxs("strong",{children:[p("proposalAcceptance.labels.total"),":"]})," $",c?.manufacturersData?.totalPrice||c?.total||0]}),e.jsxs("p",{className:"mb-1",children:[e.jsxs("strong",{children:[p("proposalAcceptance.labels.status"),":"]})," ",c?.status||p("common.na")]}),e.jsxs("p",{className:"mb-3",children:[e.jsxs("strong",{children:[p("proposalAcceptance.labels.description"),":"]})," ",c?.description||p("common.na")]})]}),e.jsxs(w,{color:"warning",className:"mb-3",children:[e.jsx("strong",{children:p("proposalAcceptance.warningTitle")})," ",p("proposalAcceptance.warningText")]}),e.jsxs(y,{children:[e.jsx(N,{id:"externalAcceptance",label:p("proposalAcceptance.externalCheck"),checked:d,onChange:e=>u(e.target.checked),className:"mb-3"}),d&&e.jsxs("div",{className:"border rounded p-3 bg-light",children:[e.jsx("h6",{className:"mb-3",children:p("proposalAcceptance.externalInfo")}),e.jsxs(v,{children:[e.jsx(C,{md:6,children:e.jsxs("div",{className:"mb-3",children:[e.jsx(A,{htmlFor:"signerName",children:p("proposalAcceptance.signerName")}),e.jsx(S,{type:"text",id:"signerName",value:x,onChange:e=>T(e.target.value),placeholder:p("proposalAcceptance.signerNamePlaceholder"),disabled:M})]})}),e.jsx(C,{md:6,children:e.jsxs("div",{className:"mb-3",children:[e.jsx(A,{htmlFor:"signerEmail",children:p("proposalAcceptance.signerEmail")}),e.jsx(S,{type:"email",id:"signerEmail",value:F,onChange:e=>B(e.target.value),placeholder:p("proposalAcceptance.signerEmailPlaceholder"),disabled:M})]})})]}),e.jsx("small",{className:"text-muted",children:p("proposalAcceptance.externalHint")})]})]})]}),e.jsxs(k,{children:[e.jsx(D,{color:"secondary",onClick:z,disabled:M,children:p("common.cancel")}),e.jsxs(D,{color:"success",onClick:async()=>{if($(""),d){if(!x.trim()&&!F.trim())return void $(p("proposalAcceptance.errors.needNameOrEmail"));if(F&&!/\S+@\S+\.\S+/.test(F))return void $(p("proposalAcceptance.errors.invalidEmail"))}L(!0);try{const e={id:c.id};d&&(x.trim()&&(e.externalSignerName=x.trim()),F.trim()&&(e.externalSignerEmail=F.trim())),await i(o(e)).unwrap(),h.fire({title:p("common.success"),text:p("proposals.toast.successAccept"),icon:"success",timer:2e3}),l?.(),t()}catch(e){$(e.message||p("proposalAcceptance.errors.failedAccept"))}finally{L(!1)}},disabled:M,className:"d-flex align-items-center gap-2",children:[M&&e.jsx(P,{size:"sm"}),p("proposalAcceptance.acceptButton")]})]})]})},ae=x(({isContractor:o,contractorGroupId:x,contractorModules:j,contractorGroupName:f})=>{const{t:g}=r(),b=m(),[w,y]=s.useState(""),[N,A]=s.useState("All"),[k,P]=s.useState(1),[ae,re]=s.useState(!1),[oe,te]=s.useState(null),ce=a(),{data:le,loading:ne,error:ie}=u(e=>e.proposal),pe=Array.isArray(le)?le:[],de=JSON.parse(localStorage.getItem("user")),me=d(de,"admin:users"),ue=["All","draft","sent","accepted","rejected","expired","Draft","Measurement Scheduled","Measurement done","Design done","Follow up 1","Follow up 2","Follow up 3","Proposal accepted","Proposal rejected"],he=e=>{switch(e){case"All":return g("proposals.tabs.all");case"draft":case"Draft":return g("proposals.status.draft");case"sent":return g("proposals.status.sent");case"accepted":return g("proposals.status.accepted");case"rejected":return g("proposals.status.rejected");case"expired":return g("proposals.status.expired");case"Measurement Scheduled":return g("proposals.status.measurementScheduled");case"Measurement done":return g("proposals.status.measurementDone");case"Design done":return g("proposals.status.designDone");case"Follow up 1":return g("proposals.status.followUp1");case"Follow up 2":return g("proposals.status.followUp2");case"Follow up 3":return g("proposals.status.followUp3");case"Proposal accepted":return g("proposals.status.proposalAccepted");case"Proposal rejected":return g("proposals.status.proposalRejected");default:return e}};s.useEffect(()=>{b(t(o?x:null))},[b,o,x]);const xe=(()=>{const e={All:pe?.length,draft:0,sent:0,accepted:0,rejected:0,expired:0,Draft:0,"Measurement Scheduled":0,"Measurement done":0,"Design done":0,"Follow up 1":0,"Follow up 2":0,"Follow up 3":0,"Proposal accepted":0,"Proposal rejected":0};return pe?.forEach(s=>{const a=s.status||"draft";void 0!==e[a]&&e[a]++}),e})(),je=pe?.filter(e=>{const s="All"===N||e.status===N,a=e.customer?.name||"",r=""===w||a.toLowerCase().includes(w.toLowerCase());return s&&r}),fe=je?.slice(10*(k-1),10*k),ge=Math.ceil((je?.length||0)/10),be=s=>{const a=(e=>{const s=e.status?.toLowerCase()||"draft";if(e.is_locked)return[];const a=[];switch(s){case"draft":a.push({type:"send",label:g("proposals.actions.send"),icon:W,color:"info"}),a.push({type:"share",label:g("proposals.actions.share"),icon:ee,color:"primary"});break;case"sent":a.push({type:"accept",label:g("proposals.actions.accept"),icon:X,color:"success"}),a.push({type:"reject",label:g("proposals.actions.reject"),icon:K,color:"danger"}),a.push({type:"share",label:g("proposals.actions.share"),icon:ee,color:"primary"});break;case"rejected":case"expired":a.push({type:"send",label:g("proposals.actions.resend"),icon:W,color:"info"}),a.push({type:"share",label:g("proposals.actions.share"),icon:ee,color:"primary"})}return o?a.filter(e=>"send"!==e.type&&"share"!==e.type):a})(s);return a.map(a=>e.jsx(D,{color:"light",size:"sm",className:"p-2 me-1",onClick:()=>{"send"===a.type?ye(s.id):"accept"===a.type?Ne(s):"reject"===a.type?ve(s.id):"share"===a.type&&Ae(s)},style:{borderRadius:"8px",border:"1px solid "+("info"===a.color?"#0dcaf0":"success"===a.color?"#198754":"danger"===a.color?"#dc3545":"#0d6efd"),transition:"all 0.2s ease"},title:a.label,children:e.jsx(F,{icon:a.icon,size:"sm",style:{color:"info"===a.color?"#0dcaf0":"success"===a.color?"#198754":"danger"===a.color?"#dc3545":"#0d6efd"}})},a.type))},we=async(e,s,a)=>{try{await b(p({id:e,action:s,status:a})).unwrap();const r={send:g("proposals.toast.successSend"),accept:g("proposals.toast.successAccept"),reject:g("proposals.toast.successReject")};h.fire(g("common.success")||"Success",r[s]||g("proposals.toast.successSend"),"success");b(t(o?x:null))}catch(r){h.fire(g("common.error"),r.message||g("proposals.toast.errorGeneric"),"error")}},ye=e=>{o||h.fire({title:g("proposals.confirm.sendTitle"),text:g("proposals.confirm.sendText"),icon:"question",showCancelButton:!0,confirmButtonText:g("proposals.confirm.sendConfirm"),cancelButtonText:g("proposals.confirm.cancel")}).then(s=>{s.isConfirmed&&we(e,"send","sent")})},Ne=e=>{te(e),re(!0)},ve=e=>{h.fire({title:g("proposals.confirm.rejectTitle"),text:g("proposals.confirm.rejectText"),icon:"warning",showCancelButton:!0,confirmButtonText:g("proposals.confirm.rejectConfirm"),cancelButtonText:g("proposals.confirm.cancel")}).then(s=>{s.isConfirmed&&we(e,"reject","rejected")})},Ce=e=>{h.fire({title:g("proposals.confirm.deleteTitle"),text:g("proposals.confirm.deleteText"),icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:g("proposals.confirm.deleteConfirm")}).then(s=>{s.isConfirmed&&b(n(e)).then(e=>{if("fulfilled"===e.meta.requestStatus){h.fire(g("common.deleted")||"Deleted",g("proposals.toast.deleted")||"Your proposal has been deleted.","success");b(t(o?x:null))}else h.fire(g("common.error"),g("proposals.toast.deleteFailed")||"Failed to delete the proposal.","error")})})},Ae=async e=>{if(!o)try{const s=(await i.post(`/api/quotes/${e.id}/sessions`)).data;if(!s?.success)throw new Error(s?.message||"Failed to create share link");const{token:a,expires_at:r}=s.data||{};if(!a)throw new Error("Session token missing in response");const c=`${window.location.origin}/p/${encodeURIComponent(a)}`,l=r?new Date(r).toLocaleString():g("common.na");await h.fire({title:g("proposals.share.createdTitle"),html:`\n          <div class="mb-2">${g("proposals.share.expires")} <b>${l}</b></div>\n          <input id="share-link" class="swal2-input" value="${c}" readonly />\n        `,showCancelButton:!0,confirmButtonText:g("proposals.share.copy"),didOpen:()=>{const e=document.getElementById("share-link");e&&(e.focus(),e.select())},preConfirm:async()=>{try{await navigator.clipboard.writeText(c)}catch(e){}}});b(t(o?x:null))}catch(s){h.fire(g("common.error"),s.message||g("proposals.share.error"),"error")}},Se=e=>{const s=`/${c(6)}/${c(8)}`+l("/quotes/edit/:id",{id:e});ce(s)},ke=e=>({draft:"secondary",sent:"info",accepted:"success",rejected:"danger",expired:"warning",Draft:"secondary","Measurement Scheduled":"info","Measurement done":"primary","Design done":"success","Follow up 1":"warning","Follow up 2":"warning","Follow up 3":"warning","Proposal accepted":"success","Proposal rejected":"danger"}[e]||"secondary");return e.jsxs(T,{fluid:!0,className:"dashboard-container",children:[e.jsxs(O,{title:g("proposals.header"),subtitle:g("proposals.subtitle"),icon:H,children:[e.jsx(_,{permission:"proposals:create",children:e.jsxs(D,{color:"light",onClick:()=>{ce("/quotes/create")},children:[e.jsx(F,{icon:V,className:"me-2"}),g("proposals.new")]})}),e.jsx(_,{permission:"proposals:create",children:e.jsx(D,{color:"success",className:"btn-gradient-green",onClick:()=>{ce("/quotes/create?quick=yes")},children:g("proposals.quick")})})]}),e.jsx("div",{className:"tabs-container",children:ue.map((s,a)=>{const r=N===s,o=xe[s]||0;return 0!==o||"All"===s||ue.slice(0,6).includes(s)?e.jsxs(D,{color:"light",className:"tab-button "+(r?"active":""),onClick:()=>{A(s),P(1)},children:[he(s),e.jsx(B,{color:r?"light":"secondary",shape:"rounded-pill",className:"ms-2",children:o})]},a):null})}),e.jsx(M,{className:"filter-card",children:e.jsx(L,{children:e.jsxs(v,{className:"align-items-center g-3",children:[e.jsx(C,{md:8,children:e.jsxs(E,{children:[e.jsx($,{children:e.jsx(F,{icon:Y})}),e.jsx(S,{type:"text",placeholder:g("proposals.searchPlaceholder"),value:w,onChange:e=>y(e.target.value)})]})}),e.jsx(C,{md:4,className:"text-md-end",children:e.jsx("small",{className:"text-muted",children:g("proposals.showingCount",{count:je?.length||0,total:pe?.length||0})})})]})})}),e.jsx("div",{className:"table-responsive-md",children:e.jsx(M,{className:"data-table-card",children:e.jsxs(z,{hover:!0,children:[e.jsx(q,{children:e.jsxs(R,{children:[e.jsx(U,{children:g("proposals.headers.date")}),e.jsx(U,{children:g("proposals.headers.customer")}),e.jsx(U,{children:g("proposals.headers.description")}),me&&e.jsx(U,{children:g("proposals.headers.designer")}),e.jsx(U,{children:g("proposals.headers.status")}),e.jsx(U,{className:"text-center",children:g("proposals.headers.actions")})]})}),e.jsx(Z,{children:0===fe?.length?e.jsx(R,{children:e.jsxs(I,{colSpan:me?6:5,className:"text-center py-5",children:[e.jsx(F,{icon:Y,size:"3xl",className:"text-muted mb-3"}),e.jsx("p",{className:"mb-0",children:g("proposals.empty.title")}),e.jsx("small",{className:"text-muted",children:g("proposals.empty.subtitle")})]})}):fe?.map(s=>e.jsxs(R,{children:[e.jsx(I,{children:new Date(s.date||s.createdAt).toLocaleDateString()}),e.jsx(I,{className:"fw-medium",style:{cursor:"pointer",color:"var(--cui-primary)"},onClick:()=>s.customer?.id&&ce(`/customers/edit/${s.customer.id}`),children:s.customer?.name||g("common.na")}),e.jsx(I,{className:"text-muted",children:s.description||g("common.na")}),me&&e.jsx(I,{children:s.designerData?.name||g("common.na")}),e.jsx(I,{children:e.jsx(B,{color:ke(s.status||"Draft"),shape:"rounded-pill",children:he(s.status||"Draft")})}),e.jsx(I,{className:"text-center",children:e.jsxs("div",{className:"d-flex justify-content-center gap-2",children:[be(s),e.jsx(_,{action:"update",resource:"proposal",item:s,children:e.jsx(D,{color:"primary",variant:"outline",size:"sm",onClick:()=>Se(s.id),children:e.jsx(F,{icon:J})})}),!s.is_locked&&e.jsx(_,{action:"delete",resource:"proposal",item:s,children:e.jsx(D,{color:"danger",variant:"outline",size:"sm",onClick:()=>Ce(s.id),children:e.jsx(F,{icon:Q})})})]})})]},s.id))})]})})}),e.jsx("div",{className:"mobile-card-view d-none",children:0===fe?.length?e.jsx(M,{children:e.jsxs(L,{className:"text-center py-5",children:[e.jsx(F,{icon:Y,size:"3xl",className:"text-muted mb-3"}),e.jsx("p",{className:"mb-0",children:g("proposals.empty.title")}),e.jsx("small",{className:"text-muted",children:g("proposals.empty.subtitle")})]})}):fe?.map(s=>e.jsx(M,{className:"proposal-mobile-card",children:e.jsxs(L,{children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-start",children:[e.jsx("div",{className:"customer-name",children:s.customer?.name||g("common.na")}),e.jsx(B,{color:ke(s.status||"Draft"),shape:"rounded-pill",children:he(s.status||"Draft")})]}),e.jsxs("div",{className:"proposal-details",children:[e.jsx("div",{className:"detail-item",children:e.jsx("span",{children:new Date(s.date||s.createdAt).toLocaleDateString()})}),e.jsx("div",{className:"detail-item",children:e.jsx("span",{children:s.description||g("common.na")})}),me&&e.jsxs("div",{className:"detail-item",children:[e.jsxs("strong",{children:[g("proposals.headers.designer"),":"]}),e.jsx("span",{children:s.designerData?.name||g("common.na")})]})]}),e.jsxs("div",{className:"actions",children:[be(s),e.jsx(_,{action:"update",resource:"proposal",item:s,children:e.jsxs(D,{color:"primary",variant:"outline",size:"sm",onClick:()=>Se(s.id),children:[e.jsx(F,{icon:J,className:"me-1"}),g("common.edit")]})}),!s.is_locked&&e.jsx(_,{action:"delete",resource:"proposal",item:s,children:e.jsxs(D,{color:"danger",variant:"outline",size:"sm",onClick:()=>Ce(s.id),children:[e.jsx(F,{icon:Q,className:"me-1"}),g("common.delete")]})})]})]})},s.id))}),e.jsx(M,{className:"data-table-card mt-4",children:e.jsx(L,{children:e.jsx(G,{currentPage:k,totalPages:ge,onPageChange:e=>{P(e)},itemsPerPage:10})})}),e.jsx(se,{show:ae,onClose:()=>re(!1),proposal:oe,onAcceptanceComplete:()=>{b(t(o?x:null)),te(null)},isContractor:o})]})},"proposals");export{ae as default};
