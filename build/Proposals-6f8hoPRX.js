import{j as e}from"./date-vendor-D9pAgX5F.js";import{r as s,u as a}from"./react-vendor-DF7UJAlN.js";import{u as o,q as r,r as t,t as l,a as c,v as n}from"./index-DW-yAxzW.js";import{h as i,P as p,g as d,b as m,e as u}from"./DefaultLayout-BUcG_pV2.js";import{u as h,a as x}from"./redux-vendor-BzdbewH4.js";import{S as j}from"./utils-vendor-Nl-sF5xe.js";import{w as b}from"./withContractorScope-CFJqUjZ-.js";import{i as f,j as g,k as y,l as N,a as w,H as v,a6 as C,U as k,V as A,I as S,J as q,m as D,e as P,C as F,h as T,u as L,v as M,W as _,X as B,b as $,$ as E,a0 as z,a1 as I,a2 as R,a3 as U,a4 as Z,o as G,p as H,r as O,t as J,d as V}from"./ui-vendor-DjmSPU99.js";import{P as X}from"./PermissionGate-D8-c0sYS.js";import{P as Y}from"./PaginationComponent-B2yVAl0f.js";import{a as Q}from"./index-BmyYYes_.js";import{c as W}from"./cil-plus-D8mtC-W5.js";import{c as K}from"./cil-search-CDkY_4k-.js";import{c as ee}from"./cil-pencil-m516yCOw.js";import{c as se}from"./cil-trash-CBbKHhHb.js";import{c as ae}from"./cil-paper-plane-haInf9fd.js";import"./form-vendor-CKNVq0c_.js";import"./icons-vendor-D82TZqJV.js";var oe=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M199.066,456l-7.379-7.514-3.94-3.9-86.2-86.2.053-.055L17.936,274.665l97.614-97.613,83.565,83.565L398.388,61.344,496,158.958,296.729,358.229,285.469,369.6ZM146.6,358.183l52.459,52.46.1-.1.054.054,52.311-52.311,11.259-11.368L450.746,158.958,398.388,106.6,199.115,305.871,115.55,222.306,63.191,274.665l83.464,83.463Z' class='ci-primary'/>"],re=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M474.444,19.857a20.336,20.336,0,0,0-21.592-2.781L33.737,213.8v38.066l176.037,70.414L322.69,496h38.074l120.3-455.4A20.342,20.342,0,0,0,474.444,19.857ZM337.257,459.693,240.2,310.37,389.553,146.788l-23.631-21.576L215.4,290.069,70.257,232.012,443.7,56.72Z' class='ci-primary'/>"];const te=({show:a,onClose:t,proposal:l,onAcceptanceComplete:c,isContractor:n=!1})=>{const i=h(),{t:p}=o(),[d,m]=s.useState(!1),[u,x]=s.useState(""),[b,T]=s.useState(""),[L,M]=s.useState(!1),[_,B]=s.useState(""),$=()=>{L||(m(!1),x(""),T(""),B(""),t())};return e.jsxs(f,{visible:a,onClose:$,size:"lg",children:[e.jsx(g,{children:e.jsx(y,{children:p("proposalAcceptance.title")})}),e.jsxs(N,{children:[_&&e.jsx(w,{color:"danger",className:"mb-3",role:"alert","aria-live":"assertive",children:_}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h6",{children:p("proposalAcceptance.details")}),e.jsxs("p",{className:"mb-1",children:[e.jsxs("strong",{children:[p("proposalAcceptance.labels.customer"),":"]})," ",l?.customer?.name||p("common.na")]}),e.jsxs("p",{className:"mb-1",children:[e.jsxs("strong",{children:[p("proposalAcceptance.labels.total"),":"]})," $",l?.manufacturersData?.totalPrice||l?.total||0]}),e.jsxs("p",{className:"mb-1",children:[e.jsxs("strong",{children:[p("proposalAcceptance.labels.status"),":"]})," ",l?.status||p("common.na")]}),e.jsxs("p",{className:"mb-3",children:[e.jsxs("strong",{children:[p("proposalAcceptance.labels.description"),":"]})," ",l?.description||p("common.na")]})]}),e.jsxs(w,{color:"warning",className:"mb-3",children:[e.jsx("strong",{children:p("proposalAcceptance.warningTitle")})," ",p("proposalAcceptance.warningText")]}),e.jsxs(v,{children:[e.jsx(C,{id:"externalAcceptance",label:p("proposalAcceptance.externalCheck"),checked:d,onChange:e=>m(e.target.checked),className:"mb-3","aria-label":p("proposalAcceptance.externalCheck")}),d&&e.jsxs("div",{className:"border rounded p-3 bg-light",children:[e.jsx("h6",{className:"mb-3",children:p("proposalAcceptance.externalInfo")}),e.jsxs(k,{children:[e.jsx(A,{md:6,children:e.jsxs("div",{className:"mb-3",children:[e.jsx(S,{htmlFor:"signerName",children:p("proposalAcceptance.signerName")}),e.jsx(q,{type:"text",id:"signerName",value:u,onChange:e=>x(e.target.value),placeholder:p("proposalAcceptance.signerNamePlaceholder"),disabled:L,"aria-label":p("proposalAcceptance.signerName")})]})}),e.jsx(A,{md:6,children:e.jsxs("div",{className:"mb-3",children:[e.jsx(S,{htmlFor:"signerEmail",children:p("proposalAcceptance.signerEmail")}),e.jsx(q,{type:"email",id:"signerEmail",value:b,onChange:e=>T(e.target.value),placeholder:p("proposalAcceptance.signerEmailPlaceholder"),disabled:L,"aria-label":p("proposalAcceptance.signerEmail")})]})})]}),e.jsx("small",{className:"text-muted",children:p("proposalAcceptance.externalHint")})]})]})]}),e.jsxs(D,{children:[e.jsx(P,{color:"secondary",onClick:$,disabled:L,style:{minHeight:"44px"},children:p("common.cancel")}),e.jsxs(P,{color:"success",onClick:async()=>{if(B(""),d){if(!u.trim()&&!b.trim())return void B(p("proposalAcceptance.errors.needNameOrEmail"));if(b&&!/\S+@\S+\.\S+/.test(b))return void B(p("proposalAcceptance.errors.invalidEmail"))}M(!0);try{const e={id:l.id};d&&(u.trim()&&(e.externalSignerName=u.trim()),b.trim()&&(e.externalSignerEmail=b.trim()));await i(r(e)).unwrap();j.fire({title:p("common.success"),text:p("proposals.toast.successAccept"),icon:"success",timer:2e3}),c?.(),t()}catch(e){B(e.message||p("proposalAcceptance.errors.failedAccept"))}finally{M(!1)}},disabled:L,className:"d-flex align-items-center gap-2",style:{minHeight:"44px"},children:[L&&e.jsx(F,{size:"sm"}),p("proposalAcceptance.acceptButton")]})]})]})},le=b(({isContractor:r,contractorGroupId:b,contractorModules:f,contractorGroupName:g})=>{const{t:y}=o(),N=h(),[w,v]=s.useState(""),[C,k]=s.useState("All"),[A,S]=s.useState(1),[D,F]=s.useState(!1),[le,ce]=s.useState(null),ne=a(),{data:ie,loading:pe,error:de}=x(e=>e.proposal),me=Array.isArray(ie)?ie:[],ue=JSON.parse(localStorage.getItem("user")),he=i(ue,"admin:users"),xe=["All","draft","sent","accepted","rejected","expired","Draft","Measurement Scheduled","Measurement done","Design done","Follow up 1","Follow up 2","Follow up 3","Proposal accepted","Proposal rejected"],je=e=>{switch(e){case"All":return y("proposals.tabs.all");case"draft":case"Draft":return y("proposals.status.draft");case"sent":return y("proposals.status.sent");case"accepted":return y("proposals.status.accepted");case"rejected":return y("proposals.status.rejected");case"expired":return y("proposals.status.expired");case"Measurement Scheduled":return y("proposals.status.measurementScheduled");case"Measurement done":return y("proposals.status.measurementDone");case"Design done":return y("proposals.status.designDone");case"Follow up 1":return y("proposals.status.followUp1");case"Follow up 2":return y("proposals.status.followUp2");case"Follow up 3":return y("proposals.status.followUp3");case"Proposal accepted":return y("proposals.status.proposalAccepted");case"Proposal rejected":return y("proposals.status.proposalRejected");default:return e}};s.useEffect(()=>{N(t(r?b:null))},[N,r,b]);const be=(()=>{const e={All:me?.length,draft:0,sent:0,accepted:0,rejected:0,expired:0,Draft:0,"Measurement Scheduled":0,"Measurement done":0,"Design done":0,"Follow up 1":0,"Follow up 2":0,"Follow up 3":0,"Proposal accepted":0,"Proposal rejected":0};return me?.forEach(s=>{const a=s.status||"draft";void 0!==e[a]&&e[a]++}),e})(),fe=me?.filter(e=>{const s="accepted"===(e.status||"").toLowerCase()||"Proposal accepted"===e.status||e.is_locked;if("All"===C&&s)return!1;const a="All"===C||e.status===C,o=e.customer?.name||"",r=""===w||o.toLowerCase().includes(w.toLowerCase());return a&&r}),ge=fe?.slice(10*(A-1),10*A),ye=Math.ceil((fe?.length||0)/10),Ne=()=>{ne("/quotes/create")},we=()=>{ne("/quotes/create?quick=yes")},ve=s=>{const a=(e=>{const s=e.status?.toLowerCase()||"draft";if(e.is_locked)return[];const a=[];switch(s){case"draft":a.push({type:"send",label:y("proposals.actions.send"),icon:ae,color:"info"}),a.push({type:"share",label:y("proposals.actions.share"),icon:re,color:"primary"});break;case"sent":a.push({type:"accept",label:y("proposals.actions.accept"),icon:oe,color:"success"}),a.push({type:"reject",label:y("proposals.actions.reject"),icon:u,color:"danger"}),a.push({type:"share",label:y("proposals.actions.share"),icon:re,color:"primary"});break;case"rejected":case"expired":a.push({type:"send",label:y("proposals.actions.resend"),icon:ae,color:"info"}),a.push({type:"share",label:y("proposals.actions.share"),icon:re,color:"primary"})}return r?a.filter(e=>"send"!==e.type&&"share"!==e.type):a})(s);return a.map(a=>e.jsx(P,{color:"light",size:"sm",className:"p-2 me-1",onClick:()=>{"send"===a.type?ke(s.id):"accept"===a.type?Ae(s):"reject"===a.type?Se(s.id):"share"===a.type&&De(s)},style:{borderRadius:"8px",border:"1px solid "+("info"===a.color?"#0dcaf0":"success"===a.color?"#198754":"danger"===a.color?"#dc3545":"#0d6efd"),transition:"all 0.2s ease"},title:a.label,children:e.jsx(L,{icon:a.icon,size:"sm",style:{color:"info"===a.color?"#0dcaf0":"success"===a.color?"#198754":"danger"===a.color?"#dc3545":"#0d6efd"}})},a.type))},Ce=async(e,s,a)=>{try{await N(n({id:e,action:s,status:a})).unwrap();const o={send:y("proposals.toast.successSend"),accept:y("proposals.toast.successAccept"),reject:y("proposals.toast.successReject")};j.fire(y("common.success")||"Success",o[s]||y("proposals.toast.successSend"),"success");N(t(r?b:null))}catch(o){j.fire(y("common.error"),o.message||y("proposals.toast.errorGeneric"),"error")}},ke=e=>{r||j.fire({title:y("proposals.confirm.sendTitle"),text:y("proposals.confirm.sendText"),icon:"question",showCancelButton:!0,confirmButtonText:y("proposals.confirm.sendConfirm"),cancelButtonText:y("proposals.confirm.cancel")}).then(s=>{s.isConfirmed&&Ce(e,"send","sent")})},Ae=e=>{ce(e),F(!0)},Se=e=>{j.fire({title:y("proposals.confirm.rejectTitle"),text:y("proposals.confirm.rejectText"),icon:"warning",showCancelButton:!0,confirmButtonText:y("proposals.confirm.rejectConfirm"),cancelButtonText:y("proposals.confirm.cancel")}).then(s=>{s.isConfirmed&&Ce(e,"reject","rejected")})},qe=e=>{j.fire({title:y("proposals.confirm.deleteTitle"),text:y("proposals.confirm.deleteText"),icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:y("proposals.confirm.deleteConfirm")}).then(s=>{s.isConfirmed&&N(l(e)).then(e=>{if("fulfilled"===e.meta.requestStatus){j.fire(y("common.deleted")||"Deleted",y("proposals.toast.deleted")||"Your quote has been deleted.","success");N(t(r?b:null))}else j.fire(y("common.error"),y("proposals.toast.deleteFailed")||"Failed to delete the quote.","error")})})},De=async e=>{if(!r)try{const s=(await c.post(`/api/quotes/${e.id}/sessions`)).data;if(!s?.success)throw new Error(s?.message||"Failed to create share link");const{token:a,expires_at:o}=s.data||{};if(!a)throw new Error("Session token missing in response");const l=`${window.location.origin}/p/${encodeURIComponent(a)}`,n=o?new Date(o).toLocaleString():y("common.na");await j.fire({title:y("proposals.share.createdTitle"),html:`\n          <div class="mb-2">${y("proposals.share.expires")} <b>${n}</b></div>\n          <input id="share-link" class="swal2-input" value="${l}" readonly />\n        `,showCancelButton:!0,confirmButtonText:y("proposals.share.copy"),didOpen:()=>{const e=document.getElementById("share-link");e&&(e.focus(),e.select())},preConfirm:async()=>{try{await navigator.clipboard.writeText(l)}catch(e){}}});N(t(r?b:null))}catch(s){j.fire(y("common.error"),s.message||y("proposals.share.error"),"error")}},Pe=e=>{const s=`/${d(6)}/${d(8)}`+m("/quotes/edit/:id",{id:e});ne(s)},Fe=e=>({draft:"secondary",sent:"info",accepted:"success",rejected:"danger",expired:"warning",Draft:"secondary","Measurement Scheduled":"info","Measurement done":"primary","Design done":"success","Follow up 1":"warning","Follow up 2":"warning","Follow up 3":"warning","Proposal accepted":"success","Proposal rejected":"danger"}[e]||"secondary");return e.jsxs(T,{fluid:!0,className:"dashboard-container",children:[e.jsx("style",{children:"\n        /* Visibility helpers hook into our global _responsive.scss classes */\n        .q-toolbar { position: sticky; top: 0; z-index: 1030; background: var(--surface, #fff); padding: .5rem; border-bottom: 1px solid var(--border, #e5e7eb); }\n        .q-chips { display: grid; grid-auto-flow: column; grid-auto-columns: max-content; gap: .5rem; overflow-x: auto; -webkit-overflow-scrolling: touch; padding: .25rem .125rem; }\n        .q-search .form-control { min-height: 44px; }\n        .q-list { display: grid; gap: .5rem; content-visibility: auto; contain-intrinsic-size: 300px; }\n        .q-list .card--compact { border-radius: 12px; border: 1px solid var(--border, #e5e7eb); }\n        .q-list .card__head { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: .5rem; }\n        .q-list .status-pill { justify-self: end; }\n        .q-actions { display: flex; gap: .375rem; align-items: center; margin-top: .5rem; }\n        .q-actions .icon-btn, .q-actions .btn-icon { min-width: 44px; min-height: 44px; }\n        .bottom-bar { position: sticky; bottom: 0; z-index: 1030; display: grid; grid-template-columns: 1fr 1fr; gap: .5rem; padding: .5rem; background: color-mix(in oklch, var(--surface, #fff) 90%, #fff); border-top: 1px solid var(--border, #e5e7eb); }\n        .clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }\n        /* Desktop table wrapper */\n        .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }\n      "}),e.jsxs(p,{title:y("proposals.header"),subtitle:y("proposals.subtitle"),icon:Q,children:[e.jsx(X,{permission:"proposals:create",children:e.jsxs(P,{color:"light",onClick:Ne,children:[e.jsx(L,{icon:W,className:"me-2"}),y("proposals.new")]})}),e.jsx(X,{permission:"proposals:create",children:e.jsx(P,{color:"success",className:"btn-gradient-green",onClick:we,children:y("proposals.quick")})})]}),e.jsx("div",{className:"segmented u-desktop",role:"tablist","aria-label":y("proposals.tabs.ariaLabel","Quote status tabs"),children:xe.map((s,a)=>{const o=C===s,r=be[s]||0;return 0!==r||"All"===s||xe.slice(0,6).includes(s)?e.jsxs("label",{className:o?"selected":"",children:[e.jsx("input",{type:"radio",name:"proposalTab",value:s,checked:o,onChange:()=>{k(s),S(1)}}),je(s),e.jsx(M,{color:o?"light":"secondary",shape:"rounded-pill",className:"ms-2",children:r})]},a):null})}),e.jsxs("div",{className:"toolbar u-desktop",role:"search",children:[e.jsxs(_,{children:[e.jsx(B,{children:e.jsx(L,{icon:K})}),e.jsx(q,{type:"text",className:"search",placeholder:y("proposals.searchPlaceholder"),value:w,onChange:e=>v(e.target.value)})]}),e.jsx("small",{className:"text-muted",children:y("proposals.showingCount",{count:fe?.length||0,total:me?.length||0})})]}),e.jsx("div",{className:"u-desktop",children:e.jsx("div",{className:"table-wrap",children:e.jsx($,{className:"data-table-card",children:e.jsxs(E,{hover:!0,className:"table-modern",role:"table",children:[e.jsx(z,{children:e.jsxs(I,{children:[e.jsx(R,{scope:"col",className:"sticky-col",children:y("proposals.headers.date")}),e.jsx(R,{scope:"col",children:y("proposals.headers.customer")}),e.jsx(R,{scope:"col",children:y("proposals.headers.description")}),he&&e.jsx(R,{scope:"col",children:y("proposals.headers.designer")}),e.jsx(R,{scope:"col",children:y("proposals.headers.status")}),e.jsx(R,{scope:"col",className:"text-center",children:y("proposals.headers.actions")})]})}),e.jsx(U,{children:0===ge?.length?e.jsx(I,{children:e.jsxs(Z,{colSpan:he?6:5,className:"text-center py-5",children:[e.jsx(L,{icon:K,size:"3xl",className:"text-muted mb-3"}),e.jsx("p",{className:"mb-0",children:y("proposals.empty.title")}),e.jsx("small",{className:"text-muted",children:y("proposals.empty.subtitle")})]})}):ge?.map(s=>e.jsxs(I,{children:[e.jsx(Z,{children:new Date(s.date||s.createdAt).toLocaleDateString()}),e.jsx(Z,{className:"fw-medium",style:{cursor:"pointer",color:"var(--cui-primary)"},onClick:()=>s.customer?.id&&ne(`/customers/edit/${s.customer.id}`),children:s.customer?.name||y("common.na")}),e.jsx(Z,{className:"text-muted",children:s.description||y("common.na")}),he&&e.jsx(Z,{children:s.designerData?.name||y("common.na")}),e.jsx(Z,{children:e.jsx(M,{color:Fe(s.status||"Draft"),shape:"rounded-pill",children:je(s.status||"Draft")})}),e.jsx(Z,{className:"text-center",children:e.jsxs("div",{className:"d-flex justify-content-center gap-2",children:[ve(s),e.jsx(X,{action:"update",resource:"proposal",item:s,children:e.jsx("button",{className:"icon-btn","aria-label":y("common.edit"),onClick:()=>Pe(s.id),children:e.jsx(L,{icon:ee})})}),!s.is_locked&&e.jsx(X,{action:"delete",resource:"proposal",item:s,children:e.jsx("button",{className:"icon-btn","aria-label":y("common.delete"),onClick:()=>qe(s.id),children:e.jsx(L,{icon:se})})})]})})]},s.id))})]})})})}),(()=>{const[a,o]=s.useState(10),r=(fe||[]).slice(0,a);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"q-toolbar u-mobile",role:"region","aria-label":y("proposals.mobile.toolbar","Filters and search"),children:[e.jsx("div",{className:"q-chips",children:xe.slice(0,6).map((s,a)=>{const r=be[s]||0;if(0===r&&"All"!==s)return null;const t=C===s;return e.jsxs("button",{type:"button",className:"btn btn-sm "+(t?"btn-dark":"btn-light"),style:{borderRadius:"999px"},onClick:()=>{k(s),S(1),o(10)},"aria-pressed":t,"aria-label":`${je(s)} (${r})`,children:[je(s)," ",e.jsx("span",{className:"ms-1 badge text-bg-secondary",children:r})]},`chip-${a}`)})}),e.jsx("div",{className:"mt-2",children:e.jsxs(_,{className:"q-search",children:[e.jsx(B,{children:e.jsx(L,{icon:K})}),e.jsx(q,{type:"text",placeholder:y("proposals.searchPlaceholder"),value:w,onChange:e=>{v(e.target.value),o(10)},"aria-label":y("proposals.searchAria","Search quotes by customer")})]})})]}),e.jsxs("div",{className:"q-list u-mobile",children:[0===r.length?e.jsxs("div",{className:"card--compact text-center",children:[e.jsx(L,{icon:K,size:"xl",className:"text-muted mb-2"}),e.jsx("div",{children:y("proposals.empty.title")}),e.jsx("div",{className:"text-muted",style:{fontSize:"var(--fs-sub)"},children:y("proposals.empty.subtitle")})]}):r.map(s=>e.jsxs("div",{className:"card--compact",children:[e.jsxs("div",{className:"card__head",children:[e.jsx("h3",{className:"card__title",children:s.customer?.name||y("common.na")}),e.jsx(M,{color:Fe(s.status||"Draft"),className:"status-pill",children:je(s.status||"Draft")})]}),e.jsxs("div",{className:"card__meta",children:[e.jsx("span",{children:new Date(s.date||s.createdAt).toLocaleDateString()}),he&&e.jsxs("span",{children:[y("proposals.headers.designer"),": ",s.designerData?.name||y("common.na")]}),s.manufacturer?.name&&e.jsx("span",{children:s.manufacturer.name})]}),s.description&&e.jsx("p",{className:"clamp-2",children:s.description}),e.jsxs("div",{className:"q-actions",children:[!s.is_locked&&e.jsx("button",{type:"button",className:"icon-btn","aria-label":y("proposals.actions.send"),onClick:()=>ke(s.id),children:e.jsx(L,{icon:ae})}),e.jsx("button",{type:"button",className:"icon-btn",onClick:()=>Pe(s.id),"aria-label":y("common.edit"),children:e.jsx(L,{icon:ee})}),e.jsxs(G,{alignment:"end",children:[e.jsx(H,{color:"light",size:"sm",className:"btn-icon","aria-label":y("common.moreActions","More actions"),children:"⋮"}),e.jsxs(O,{children:[!s.is_locked&&e.jsxs(J,{onClick:()=>qe(s.id),children:[e.jsx(L,{icon:se,className:"me-2"})," ",y("common.delete")]}),e.jsxs(J,{onClick:()=>De(s),children:[e.jsx(L,{icon:re,className:"me-2"})," ",y("proposals.actions.share")]})]})]})]})]},s.id)),fe&&a<fe.length&&e.jsx("div",{className:"text-center mt-2",children:e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>o(e=>e+10),children:y("common.loadMore","Load more")})})]}),e.jsxs("div",{className:"bottom-bar u-mobile",role:"region","aria-label":y("proposals.mobile.primaryActions","Primary quote actions"),children:[e.jsx(X,{permission:"proposals:create",children:e.jsx(P,{color:"success",className:"flex-fill",onClick:we,children:y("proposals.quick")})}),e.jsx(X,{permission:"proposals:create",children:e.jsx(P,{color:"light",className:"flex-fill",onClick:Ne,children:y("proposals.new")})})]})]})})(),e.jsx($,{className:"data-table-card mt-4",children:e.jsx(V,{children:e.jsx(Y,{currentPage:A,totalPages:ye,onPageChange:e=>{S(e)},itemsPerPage:10})})}),e.jsx(te,{show:D,onClose:()=>F(!1),proposal:le,onAcceptanceComplete:()=>{N(t(r?b:null)),ce(null);ne(r?"/my-orders":"/orders")},isContractor:r})]})},"proposals");export{le as default};
